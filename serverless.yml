service: kovi-teste
custom:
  versions-prod2: true
  versions-default: false
  myStage: ${opt:stage, self:provider.stage}
  region: ${opt:region, self:provider.region}
  topic: payment-cards-events-${self:custom.myStage}
  mobileTopic: push-mobile-${self:custom.myStage}
  topicArn:
    Fn::Join:
      - ''
      - - "arn:aws:sns:${self:custom.region}:"
        - Ref: AWS::AccountId
        - ":${self:custom.topic}"
  mobileTopicArn:
    Fn::Join:
      - ''
      - - "arn:aws:sns:${self:custom.region}:"
        - Ref: AWS::AccountId
        - ":${self:custom.mobileTopic}"
  settings:
    dev:
      MESSAGES_TABLE: 'messages-dev'
  serverless-offline:
    port: 3030

provider:
  environment: ${self:custom.settings.${self:custom.myStage}}
  name: aws
  layers:
        # Ref name is generated by TitleCasing the layer name & appending LambdaLayer
      - {Ref: CommonLibsLambdaLayer}
  versionFunctions: ${self:custom.versions-${self:custom.myStage}, self:custom.versions-default}
  runtime: nodejs8.10
  timeout: 30
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:ListStreams
      Resource:
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.MESSAGES_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.MESSAGES_TABLE}/*"

layers:
  commonLibs:
    path: layer
    compatibleRuntimes:
      - nodejs8.10

functions: # TODO: change the handlers
  # dispatcherLogAll:
  #     handler: dispatchers/log-all.handler
  #     events:
  #       - sns: 
  #           arn: "${self:custom.topicArn}"
  #           topicName: "${self:custom.topic}"
  #           displayName: transa-evt
  endpointPost:
    handler: endpoints/post.handler
    events:
      - http:
          path: /
          method: post
          cors: true
          integration: lambda
          response:
            headers:
              Content-Type: "'application/json'"
              Access-Control-Allow-Origin: "'*'"
            template: $input.path('$')
            statusCodes:
                200:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                400:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][0].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                202:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[2][0][2].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                401:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][1].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                403:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][3].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                404:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][4].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                422:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][2][2].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"  
                500:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][0].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"                     
                503:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][3].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"            
                504:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][4].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"            
          request:
            template:
              application/json: '{
                  "method": "$context.httpMethod",
                  "body" : $input.json(''$''),
                  "headers": {
                    #foreach($param in $input.params().header.keySet())
                      "$param": "$util.escapeJavaScript($input.params().header.get($param))" #if($foreach.hasNext),#end
                    #end
                  },
                  "queryParams": {
                    #foreach($param in $input.params().querystring.keySet())
                      "$param": "$util.escapeJavaScript($input.params().querystring.get($param))" #if($foreach.hasNext),#end
                    #end
                  },
                  "pathParams": {
                    #foreach($param in $input.params().path.keySet())
                      "$param": "$util.escapeJavaScript($input.params().path.get($param))" #if($foreach.hasNext),#end
                    #end
                  }
                }'
  endpointGetMESSAGEID:
    handler: endpoints/getMESSAGEID.handler
    events:
      - http:
          path: /{messageid}
          method: get
          cors: true
          integration: lambda
          response:
            headers:
              Content-Type: "'application/json'"
              Access-Control-Allow-Origin: "'*'"
            template: $input.path('$')
            statusCodes:
                200:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                    pattern: '' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                400:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][0].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                202:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[2][0][2].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                401:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][1].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                403:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][3].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                404:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][4].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"
                422:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][2][2].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"  
                500:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][0].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"                     
                503:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][3].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"            
                504:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][4].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                      Content-Type: "'application/json'"            
          request:
            template:
              application/json: '{
                  "method": "$context.httpMethod",
                  "body" : $input.json(''$''),
                  "headers": {
                    #foreach($param in $input.params().header.keySet())
                      "$param": "$util.escapeJavaScript($input.params().header.get($param))" #if($foreach.hasNext),#end
                    #end
                  },
                  "queryParams": {
                    #foreach($param in $input.params().querystring.keySet())
                      "$param": "$util.escapeJavaScript($input.params().querystring.get($param))" #if($foreach.hasNext),#end
                    #end
                  },
                  "pathParams": {
                    #foreach($param in $input.params().path.keySet())
                      "$param": "$util.escapeJavaScript($input.params().path.get($param))" #if($foreach.hasNext),#end
                    #end
                  }
                }'
  streamDynamodb:
    handler: consumers/stream-dynamodb.handler
    events:
      - stream:
          type: dynamodb
          arn: arn:aws:dynamodb:us-east-1:464022323563:table/messages-dev/stream/2019-07-29T00:17:35.167
resources:
    Resources:
      GatewayResponseDefault4XX:
        Type: 'AWS::ApiGateway::GatewayResponse'
        Properties:
          ResponseParameters:
            gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
            gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
          ResponseType: DEFAULT_4XX
          RestApiId:
            Ref: 'ApiGatewayRestApi'

plugins:
  # - serverless-domain-manager
  - serverless-offline
  - serverless-plugin-tracing
